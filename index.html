<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DEV.to Query</title>
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="https://stepzen.com/images/favicon/apple-touch-icon.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="16x16"
      href="https://stepzen.com/images/favicon/favicon-16x16.png"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="https://stepzen.com/images/favicon/favicon-32x32.png"
    />
    <link
      href="https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <script
      src="https://cdn.jsdelivr.net/gh/alpinejs/alpine@v2.x.x/dist/alpine.min.js"
      defer
    ></script>
    <style>
      button:disabled {
          cursor: not-allowed;
          opacity: 0.5;
      }
    </style>
  </head>

  <body>
    <h1
      class="
        text-center text-3xl
        font-bold
        mt-24
        mb-6
        uppercase
        text-indigo-800
      "
    >
      DEV.to Query
    </h1>
    <div class="w-3/4 mx-auto" x-data="{ open: false}">
      <div x-show="open"></div>
      <form
        action="/"
        method="POST"
        class="w-3/4 mx-auto"
        x-data="idForm()"
        @submit.prevent="submitData"
      >
        <div class="w-3/4 mx-auto rounded shadow-md">
          <div>
            <p class="text-indigo-800 text-base m-2">
              StepZen's custom @rest directive operates behind the scenes in the
              sdl to retrieve dynamic information.
            </p>
          </div>
          <pre class="text-indigo-700 text-base m-2">
      @rest(endpoint: "https://dev.to/api/articles")
      </pre
          >
        </div>
        <div class="mb-4">
          <label class="block mb-2 text-indigo-900">DEV.to Username:</label>
          <input
            type="text"
            name="username"
            class="border w-full p-1"
            x-model="formData.username"
          />
        </div>

        <button
          class="
            bg-indigo-800
            hover:bg-gray-800
            disabled:opacity-50
            text-white
            w-full
            p-2
            mb-4
          "
          x-text="buttonLabel"
          :disabled="loading"
        ></button>

        <div class="w-3/4 mx-auto rounded shadow-lg">
          <pre class="text-indigo-700 text-base">
        query MyQuery {
          devto_getArticles(
            username: <span x-text="formData.username"></span>, 
            per_page: 3, 
            page: 1) {
            title
            canonical_url
            user {
              name
              twitter_username
              username
              website_url
            }
          }
        }
      
            </pre>
        </div>
        <div>
          <div class="w-3/4 mx-auto rounded shadow-lg p-2 m-2 text-indigo-900">
            Twitter Link:
            <a
              id="twitter_username"
              x-bind:href="'https://twitter.com/' + twitter_username"
              class="text-gray-700 px-6 py-3 flex items-center"
              x-text="twitter_username"
            >
            </a>
          </div>
        </div>
        <div>
          <div class="w-3/4 mx-auto rounded shadow-lg p-2 m-2 text-indigo-900">
            Website:
            <a
              id="website_url"
              x-bind:href="website_url"
              class="text-gray-700 px-6 py-3 flex items-center"
              x-text="website_url"
            >
            </a>
          </div>
        </div>
        <div>
          <div
            class="
              w-3/4
              mx-auto
              rounded
              shadow-lg
              m-2
              p-2
              overflow-scroll
              text-indigo-900
            "
          >
            First 3 Articles:
            <pre><span x-text="articles"></span></pre>
            <a
              id="article1"
              x-bind:href="article1url"
              class="text-gray-700 px-6 py-3 flex items-center"
              x-text="article1"
            ></a>
            <a
              id="article2"
              x-bind:href="article2url"
              class="text-gray-700 px-6 py-3 flex items-center"
              x-text="article2"
            ></a>
            <a
              id="article3"
              x-bind:href="article3url"
              class="text-gray-700 px-6 py-3 flex items-center"
              x-text="article3"
            ></a>
          </div>
        </div>
      </form>
    </div>
    <script>
      function idForm() {
        return {
          formData: {
            username: '',
          },
          twitter_username: '',
          website_url: '',
          articles: '',
          loading: false,
          article1: '',
          article1url: '',
          article2: '',
          article2url: '',
          article3: '',
          article3url: '',
          buttonLabel: 'Submit',

          submitData() {
            this.buttonLabel = 'Submitting...'
            this.loading = true
            const body = JSON.stringify({
              operationName: 'MyQuery',
              query: `query MyQuery ($username: String) {
  devto_getArticles(username: $username, per_page: 3, page: 1) {
    title
    canonical_url
    user {
      name
      twitter_username
      username
      website_url
    }
  }
}`,
              variables: {
                username: this.formData.username,
              },
            })
            fetch('https://mojave.stepzen.net/testing/netlifybuild/__graphql', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: body,
            })
              .then((response) => response.json())
              .then((data) => {
                if (data.data.devto_getArticles[0] === undefined) {
                  this.twitter_username = `Error: undefined`
                  this.website_url = `Error: undefined`
                  this.article1 = `Error: undefined`
                  this.article1url = `Error: undefined`
                  this.article2 = `Error: undefined`
                  this.article2url = `Error: undefined`
                  this.article3 = `Error: undefined`
                  this.article3url = `Error: undefined`
                } else {
                  this.twitter_username = `${data.data.devto_getArticles[0].user.twitter_username} `
                  this.website_url = `${data.data.devto_getArticles[0].user.website_url}`
                  this.article1 = `${data.data.devto_getArticles[0].title}`
                  this.article1url = `${data.data.devto_getArticles[0].canonical_url}`
                  this.article2 = `${data.data.devto_getArticles[1].title}`
                  this.article2url = `${data.data.devto_getArticles[1].canonical_url}`
                  this.article3 = `${data.data.devto_getArticles[2].title}`
                  this.article3url = `${data.data.devto_getArticles[2].canonical_url}`
                }
              })
              .catch((err) => {
                console.log(err)
                this.message = 'Ooops! Something went wrong!'
              })
              .finally(() => {
                this.loading = false
                this.buttonLabel = 'Submit'
              })
          },
        }
      }
    </script>
  </body>
</html>
